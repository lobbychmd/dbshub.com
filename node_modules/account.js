var db = require('config').db();

var account = function (req) {
    this.data = req.session.user;
    this.accountid = typeof this.data._id == "string" ? db.ObjectID(this.data._id) : this.data._id;
}

exports.account = account;

account.prototype = {
    getState: function (projectName, group, callback) {
        
        var query = { "Account": this.accountid  };
        if (projectName) query["ProjectName"] = projectName;
        db.collection(projectName ? 'AccountProjectPref' : 'AccountPref').findOne(query, function (err, doc) {

            callback(doc ? doc[group] : null);
        });
    },

    saveState: function (projectName, group, data, callback) {
        var c = db.collection(projectName ? 'AccountProjectPref' : 'AccountPref');
        var query = { "Account": this.accountid }
        if (projectName) query["ProjectName"] = projectName;
        var updoc = {};
        updoc[group] = data;

        c.findOne(query, function (err, doc) {
            //console.log(doc);            console.log(query);            console.log(updoc);
            if (doc) {
                c.update(query, { "$set": updoc }, function (err, row) {
                    callback();
                });
            }
            else {
                query[group] = data;
                c.insert(query, function () {
                    callback();
                });
            }
        });
    }
}